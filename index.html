<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Early Access | Ugly Cat Chain</title>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"/>

<!-- Supabase -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.3/dist/umd/supabase.js"></script>

<!-- Web3 / Ethers.js for Wallet -->
<script src="https://cdn.ethers.io/lib/ethers-5.7.umd.min.js"></script>

<!-- BIP39 for Mnemonic -->
<script src="https://cdn.jsdelivr.net/npm/bip39@3.1.0/index.js"></script>

<!-- Solana Web3.js -->
<script src="https://unpkg.com/@solana/web3.js@latest/lib/index.iife.min.js"></script>

<!-- TweetNaCl for Solana keypair -->
<script src="https://cdn.jsdelivr.net/npm/tweetnacl@1.0.3/nacl-fast.min.js"></script>

<!-- ed25519-hd-key for Solana derivation -->
<script src="https://cdn.jsdelivr.net/npm/ed25519-hd-key@1.3.0/lib/index.min.js"></script>

<style>
:root{
--bg:#0b0e14;--card:#121826;--primary:#6cf2c2;
--secondary:#8aa2ff;--text:#e6e9f0;--muted:#9aa4bf
}
*{margin:0;padding:0;box-sizing:border-box;font-family:Arial}
body{background:var(--bg);color:var(--text)}

.topbar{
position:fixed;top:0;left:0;width:100%;height:64px;
background:#0b0e14;border-bottom:1px solid #1c2335;
display:flex;align-items:center;justify-content:space-between;
padding:0 20px;z-index:1000
}
.topbar img{width:36px}
.title{position:absolute;left:50%;transform:translateX(-50%);font-weight:bold}
.menu-btn{font-size:24px;cursor:pointer}

.hamburger-menu{
position:fixed;top:64px;right:5px;width:210px;
background:var(--card);border-radius:16px;
padding:16px;display:none;flex-direction:column;gap:10px;
box-shadow:0 20px 40px rgba(0,0,0,.5);z-index:1200
}
.hamburger-menu a{
color:var(--text);text-decoration:none;font-weight:bold;
padding:12px;border-radius:12px
}
.hamburger-menu a:hover{background:rgba(108,242,194,.15);color:var(--primary)}

.profile-avatar{
position:absolute;right:20px;top:72px;
width:46px;height:46px;border-radius:50%;
background:linear-gradient(135deg,var(--primary),var(--secondary));
display:none;align-items:center;justify-content:center;
font-weight:bold;color:#000;cursor:pointer;z-index:1100
}

header{
margin-top:64px;padding:80px 20px;text-align:center;
background:linear-gradient(135deg,#0b0e14,#121826)
}
header h1{font-size:2.6rem;margin-bottom:16px}
header p{color:var(--muted);max-width:600px;margin:auto}

.login-card{
max-width:420px;margin:60px auto;
background:var(--card);padding:32px;border-radius:20px;
box-shadow:0 20px 50px rgba(0,0,0,.4);text-align:center
}
.login-card h2{margin-bottom:12px;color:var(--primary)}
.login-card p{font-size:.95rem;color:var(--muted);margin-bottom:28px}

.login-btn{
width:100%;padding:14px;border-radius:999px;border:none;
font-weight:bold;font-size:1rem;cursor:pointer;color:#000;
margin-bottom:12px;display:flex;align-items:center;justify-content:center;gap:10px
}
.btn-email{background:linear-gradient(135deg,var(--primary),var(--secondary))}
.btn-google{background:#fff;color:#000}
.btn-twitter{background:#1DA1F2;color:#fff}
.btn-discord{background:#5865F2;color:#fff}
.btn-wallet{background:linear-gradient(135deg,#ff6b6b,#ffa500);color:#fff}

.input-field{
width:100%;padding:14px;border-radius:12px;border:1px solid #1c2335;
background:var(--bg);color:var(--text);margin-bottom:12px;font-size:1rem
}
.error-msg{color:#ff6b6b;font-size:.85rem;margin-top:8px;display:none}
.success-msg{color:var(--primary);font-size:.85rem;margin-top:8px;display:none}

.otp-section{display:none}
.back-link{color:var(--primary);cursor:pointer;font-size:.9rem;margin-top:12px;display:inline-block}

.social-bar{
display:flex;justify-content:center;gap:22px;
padding:40px 20px 20px
}
.social-bar a{
width:46px;height:46px;border-radius:50%;
background:var(--card);display:flex;align-items:center;justify-content:center;
color:var(--text);font-size:20px;text-decoration:none
}
.social-bar a:hover{background:var(--primary);color:#000}

footer{
padding:40px 20px;text-align:center;
color:var(--muted);border-top:1px solid #1c2335
}

/* POPUP */
.popup{
position:fixed;inset:0;background:rgba(0,0,0,.7);
display:none;align-items:center;justify-content:center;z-index:2000
}
.popup-card{
background:var(--card);padding:36px;border-radius:20px;
text-align:center;max-width:340px;width:90%
}
.popup-card h3{color:var(--primary);margin-bottom:12px}
.popup-card p{font-size:.9rem;color:var(--muted);word-break:break-all;margin-bottom:12px}
.popup-card button{
margin-top:16px;padding:10px 22px;border-radius:999px;
border:none;background:var(--primary);cursor:pointer;color:#000;font-weight:bold
}
.divider{
display:flex;align-items:center;gap:12px;margin:20px 0;color:var(--muted);font-size:.9rem
}
.divider::before,.divider::after{content:'';flex:1;height:1px;background:#1c2335}
</style>
</head>

<body>

<div class="topbar">
<img src="https://raw.githubusercontent.com/babypandaflash/image/refs/heads/main/logo.png"/>
<div class="title">Ugly Cat Chain</div>
<div class="menu-btn">☰</div>
</div>

<div class="profile-avatar" id="avatar">U</div>

<div class="hamburger-menu" id="hamburgerMenu">
<a href="index.html">Home</a>
<a href="earlyaccess.html">Early Access</a>
<a href="#" class="coming-soon">UglyCat App</a>
<a href="#" class="coming-soon">UglyCat Wallet</a>
<a href="#" class="coming-soon">UglyCat NFT</a>
<a href="#" class="coming-soon">Marketplace</a>
<a href="#" class="coming-soon">Tokenomics</a>
<a href="roadmap.html">Roadmap</a>
</div>

<header>
<h1>Early Community Access</h1>
<p>Join the earliest members of Ugly Cat Chain and unlock exclusive NFT utilities, early features, and future rewards.</p>
</header>

<div class="login-card" id="loginCard">
<h2>Join Early Community</h2>
<p>Sign in using your preferred method to secure your early access spot.</p>

<!-- Email OTP Section -->
<div id="emailSection">
<input type="email" id="emailInput" class="input-field" placeholder="Enter your email" />
<button class="login-btn btn-email" id="sendOtpBtn">
<i class="fas fa-envelope"></i> Continue with Email
</button>
</div>

<!-- OTP Verification Section -->
<div class="otp-section" id="otpSection">
<input type="text" id="otpInput" class="input-field" placeholder="Enter 6-digit OTP code" maxlength="6" />
<button class="login-btn btn-email" id="verifyOtpBtn">
<i class="fas fa-check"></i> Verify OTP
</button>
<span class="back-link" id="backToEmail">← Back to email</span>
</div>

<div class="error-msg" id="errorMsg"></div>
<div class="success-msg" id="successMsg"></div>

<div class="divider">OR</div>

<!-- Social Login Buttons -->
<button class="login-btn btn-google" id="googleBtn">
<i class="fa-brands fa-google"></i> Continue with Google
</button>

<button class="login-btn btn-twitter" id="twitterBtn">
<i class="fa-brands fa-x-twitter"></i> Continue with Twitter
</button>

<button class="login-btn btn-discord" id="discordBtn">
<i class="fa-brands fa-discord"></i> Continue with Discord
</button>

<div class="divider">OR</div>

<!-- Wallet Connect Button -->
<button class="login-btn btn-wallet" id="walletBtn">
<i class="fas fa-wallet"></i> Connect Wallet
</button>
</div>

<div class="social-bar">
<a href="#"><i class="fa-brands fa-x-twitter"></i></a>
<a href="#"><i class="fa-brands fa-discord"></i></a>
<a href="#"><i class="fa-brands fa-instagram"></i></a>
<a href="#"><i class="fa-brands fa-telegram"></i></a>
<a href="#"><i class="fa-brands fa-youtube"></i></a>
</div>

<footer>© 2025 Ugly Cat Chain. All rights reserved.</footer>

<!-- COMING SOON -->
<div class="popup" id="comingSoonPopup">
<div class="popup-card">
<h3>Coming Soon</h3>
<p>This feature is under development.</p>
<button id="closeComing">Close</button>
</div>
</div>

<!-- PROFILE POPUP -->
<div class="popup" id="profilePopup">
<div class="popup-card" style="max-width:400px">
<h3>Your Profile</h3>
<p><strong>Email/ID</strong><br><span id="userEmail"></span></p>
<p><strong>Login Method</strong><br><span id="loginMethod"></span></p>

<div id="generatedWalletsSection" style="margin-top:16px">
<p><strong>EVM Wallet Address</strong><br><span id="evmWalletAddress" style="font-size:.85rem;word-break:break-all"></span></p>
<p style="margin-top:12px"><strong>Solana Wallet Address</strong><br><span id="solanaWalletAddress" style="font-size:.85rem;word-break:break-all"></span></p>
</div>

<p id="connectedWalletInfo" style="display:none;margin-top:12px"><strong>Connected Wallet</strong><br><span id="walletAddress" style="font-size:.85rem;word-break:break-all"></span></p>

<div id="walletActionsSection" style="display:none;margin-top:16px">
<button id="copyMnemonicBtn" style="margin-bottom:8px">Copy Mnemonic</button><br/>
<button id="exportWalletBtn" style="margin-bottom:8px">Export Wallet</button><br/>
</div>

<button id="logoutBtn">Logout</button><br/>
<button id="closeProfile">Close</button>
</div>
</div>

<script>
// Check if Supabase loaded
if (typeof supabase === 'undefined') {
  console.error('Supabase library failed to load!');
  alert('Error loading authentication library. Please refresh the page.');
}

// KONFIGURASI SUPABASE - GANTI DENGAN CREDENTIALS ANDA
const SUPABASE_URL = 'https://fpnxffmoyvmwqkuorjba.supabase.co'; // Ganti dengan URL Supabase Anda
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZwbnhmZm1veXZtd3FrdW9yamJhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYwNzcyMDksImV4cCI6MjA4MTY1MzIwOX0.PTzCzbDxrJeub92_FmcEytMm-y9x3wBHFzSan71P5Q8'; // Ganti dengan Anon Key Anda

// Validate credentials
if (SUPABASE_URL === 'YOUR_SUPABASE_URL' || SUPABASE_ANON_KEY === 'YOUR_SUPABASE_ANON_KEY') {
  console.error('Please update SUPABASE_URL and SUPABASE_ANON_KEY with your actual credentials!');
}

const { createClient } = supabase;
const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* Hamburger */
const menuBtn = document.querySelector('.menu-btn');
const menu = document.getElementById('hamburgerMenu');
menuBtn.onclick = () => menu.style.display = menu.style.display === 'flex' ? 'none' : 'flex';
document.addEventListener('click', e => {
  if (!menu.contains(e.target) && !menuBtn.contains(e.target)) menu.style.display = 'none'
});

/* Coming Soon */
const comingSoonPopup = document.getElementById('comingSoonPopup');
document.querySelectorAll('.coming-soon').forEach(el => {
  el.onclick = e => { e.preventDefault(); comingSoonPopup.style.display = 'flex'; menu.style.display = 'none' }
});
document.getElementById('closeComing').onclick = () => comingSoonPopup.style.display = 'none';

/* UI Elements */
const loginCard = document.getElementById('loginCard');
const avatar = document.getElementById('avatar');
const profilePopup = document.getElementById('profilePopup');
const emailInput = document.getElementById('emailInput');
const otpInput = document.getElementById('otpInput');
const emailSection = document.getElementById('emailSection');
const otpSection = document.getElementById('otpSection');
const errorMsg = document.getElementById('errorMsg');
const successMsg = document.getElementById('successMsg');

let currentEmail = '';
let currentWallets = null;

// Generate EVM and Solana wallets from ONE mnemonic
async function generateWallets(userId) {
  try {
    console.log('Generating wallets from mnemonic for user:', userId);
    
    // Generate 12-word mnemonic phrase
    const mnemonic = bip39.generateMnemonic();
    console.log('Mnemonic generated:', mnemonic);
    
    // Derive seed from mnemonic
    const seed = await bip39.mnemonicToSeed(mnemonic);
    
    // ===== Generate EVM Wallet (Ethereum, BSC, Polygon, etc) =====
    // Use BIP44 path for Ethereum: m/44'/60'/0'/0/0
    const hdNode = ethers.utils.HDNode.fromSeed(seed);
    const evmPath = "m/44'/60'/0'/0/0";
    const evmWallet = hdNode.derivePath(evmPath);
    const evmAddress = evmWallet.address;
    const evmPrivateKey = evmWallet.privateKey;
    
    console.log('EVM Wallet generated:', evmAddress);
    
    // ===== Generate Solana Wallet =====
    // Use BIP44 path for Solana: m/44'/501'/0'/0'
    const solanaPath = "m/44'/501'/0'/0'";
    const solanaSeed = seed.slice(0, 32); // Solana uses first 32 bytes
    
    // Derive Solana keypair from seed using ed25519-hd-key
    const derivedSeed = EDKey.derivePath(solanaPath, seed.toString('hex')).key;
    const solanaKeypair = nacl.sign.keyPair.fromSeed(derivedSeed);
    
    const solanaPublicKey = solanaKeypair.publicKey;
    const solanaSecretKey = solanaKeypair.secretKey;
    const solanaAddress = new solanaWeb3.PublicKey(solanaPublicKey).toBase58();
    
    console.log('Solana Wallet generated:', solanaAddress);
    
    // Store encrypted wallets in user metadata
    const walletData = {
      mnemonic: mnemonic, // In production, ENCRYPT this!
      evm_address: evmAddress,
      evm_private_key: evmPrivateKey, // Derived from mnemonic
      evm_path: evmPath,
      solana_address: solanaAddress,
      solana_secret_key: Array.from(solanaSecretKey), // Derived from mnemonic
      solana_path: solanaPath,
      created_at: new Date().toISOString()
    };
    
    // Update user metadata
    const { data, error } = await supabaseClient.auth.updateUser({
      data: {
        wallets: walletData
      }
    });
    
    if (error) {
      console.error('Error saving wallets:', error);
      throw error;
    }
    
    console.log('Wallets saved to user metadata');
    
    return walletData;
    
  } catch (error) {
    console.error('Error generating wallets:', error);
    throw error;
  }
}

// Get or create wallets for user
async function getOrCreateWallets(user) {
  try {
    // Check if user already has wallets
    if (user.user_metadata?.wallets) {
      console.log('User already has wallets');
      return user.user_metadata.wallets;
    }
    
    // Generate new wallets
    console.log('Generating new wallets for user');
    const wallets = await generateWallets(user.id);
    return wallets;
    
  } catch (error) {
    console.error('Error in getOrCreateWallets:', error);
    return null;
  }
}

// Helper functions
function showError(message) {
  errorMsg.textContent = message;
  errorMsg.style.display = 'block';
  successMsg.style.display = 'none';
}

function showSuccess(message) {
  successMsg.textContent = message;
  successMsg.style.display = 'block';
  errorMsg.style.display = 'none';
}

function hideMessages() {
  errorMsg.style.display = 'none';
  successMsg.style.display = 'none';
}

// Send OTP to Email
document.getElementById('sendOtpBtn').onclick = async () => {
  const email = emailInput.value.trim();
  hideMessages();
  
  if (!email) {
    showError('Please enter your email');
    return;
  }
  
  if (!email.includes('@')) {
    showError('Please enter a valid email');
    return;
  }
  
  try {
    console.log('Sending OTP to:', email);
    const { data, error } = await supabaseClient.auth.signInWithOtp({
      email: email,
      options: {
        shouldCreateUser: true
      }
    });
    
    if (error) {
      console.error('OTP Error:', error);
      throw error;
    }
    
    console.log('OTP sent successfully:', data);
    currentEmail = email;
    emailSection.style.display = 'none';
    otpSection.style.display = 'block';
    showSuccess('OTP sent to your email! Please check your inbox.');
  } catch (error) {
    console.error('Error:', error);
    showError(error.message || 'Failed to send OTP');
  }
};

// Verify OTP
document.getElementById('verifyOtpBtn').onclick = async () => {
  const otp = otpInput.value.trim();
  hideMessages();
  
  if (!otp || otp.length !== 6) {
    showError('Please enter the 6-digit OTP code');
    return;
  }
  
  try {
    const { data, error } = await supabaseClient.auth.verifyOtp({
      email: currentEmail,
      token: otp,
      type: 'email'
    });
    
    if (error) throw error;
    
    // Generate wallets for new user
    const wallets = await getOrCreateWallets(data.user);
    currentWallets = wallets;
    
    showUserProfile(data.user, 'Email OTP', wallets);
  } catch (error) {
    showError('Invalid OTP code. Please try again.');
  }
};

// Back to email
document.getElementById('backToEmail').onclick = () => {
  otpSection.style.display = 'none';
  emailSection.style.display = 'block';
  otpInput.value = '';
  hideMessages();
};

// Google Login
document.getElementById('googleBtn').onclick = async () => {
  hideMessages();
  try {
    console.log('Attempting Google login...');
    const { data, error } = await supabaseClient.auth.signInWithOAuth({
      provider: 'google',
      options: {
        redirectTo: window.location.href
      }
    });
    if (error) {
      console.error('Google login error:', error);
      throw error;
    }
    console.log('Google login initiated:', data);
  } catch (error) {
    console.error('Error:', error);
    showError(error.message || 'Failed to login with Google');
  }
};

// Twitter Login
document.getElementById('twitterBtn').onclick = async () => {
  hideMessages();
  try {
    console.log('Attempting Twitter login...');
    const { data, error } = await supabaseClient.auth.signInWithOAuth({
      provider: 'twitter',
      options: {
        redirectTo: window.location.href
      }
    });
    if (error) {
      console.error('Twitter login error:', error);
      throw error;
    }
    console.log('Twitter login initiated:', data);
  } catch (error) {
    console.error('Error:', error);
    showError(error.message || 'Failed to login with Twitter');
  }
};

// Discord Login
document.getElementById('discordBtn').onclick = async () => {
  hideMessages();
  try {
    console.log('Attempting Discord login...');
    const { data, error } = await supabaseClient.auth.signInWithOAuth({
      provider: 'discord',
      options: {
        redirectTo: window.location.href
      }
    });
    if (error) {
      console.error('Discord login error:', error);
      throw error;
    }
    console.log('Discord login initiated:', data);
  } catch (error) {
    console.error('Error:', error);
    showError(error.message || 'Failed to login with Discord');
  }
};

// Connect Wallet (MetaMask)
document.getElementById('walletBtn').onclick = async () => {
  hideMessages();
  
  if (typeof window.ethereum === 'undefined') {
    showError('Please install MetaMask or another Web3 wallet');
    return;
  }
  
  try {
    console.log('Connecting to MetaMask...');
    const provider = new ethers.providers.Web3Provider(window.ethereum);
    const accounts = await provider.send("eth_requestAccounts", []);
    const address = accounts[0];
    const signer = provider.getSigner();
    
    console.log('Wallet connected:', address);
    
    // Create a message to sign
    const message = `Sign this message to login to Ugly Cat Chain\n\nWallet: ${address}\nTimestamp: ${Date.now()}`;
    console.log('Requesting signature...');
    const signature = await signer.signMessage(message);
    
    console.log('Signature received:', signature);
    
    // Create an anonymous user and link wallet
    const { data: authData, error: authError } = await supabaseClient.auth.signInAnonymously();
    
    if (authError) {
      console.error('Auth error:', authError);
      throw authError;
    }
    
    console.log('Anonymous user created:', authData);
    
    // Update user metadata with wallet info
    const { data: updateData, error: updateError } = await supabaseClient.auth.updateUser({
      data: {
        wallet_address: address,
        wallet_signature: signature,
        login_method: 'wallet'
      }
    });
    
    if (updateError) {
      console.error('Update error:', updateError);
      throw updateError;
    }
    
    console.log('User metadata updated:', updateData);
    
    // Show profile
    showUserProfile({
      id: authData.user.id,
      email: `${address.substring(0, 6)}...${address.substring(address.length - 4)}`,
      user_metadata: { 
        wallet_address: address,
        login_method: 'wallet'
      }
    }, 'Wallet', address);
    
    showSuccess('Wallet connected successfully!');
    
  } catch (error) {
    console.error('Wallet connection error:', error);
    if (error.code === 4001) {
      showError('Wallet connection cancelled');
    } else if (error.code === -32602) {
      showError('Invalid wallet request');
    } else {
      showError('Failed to connect wallet: ' + (error.message || 'Unknown error'));
    }
  }
};

// Show user profile
function showUserProfile(user, method, wallets = null) {
  console.log('Showing profile for user:', user);
  loginCard.style.display = 'none';
  avatar.style.display = 'flex';
  
  // Get wallet from user metadata if available
  const connectedWallet = user.user_metadata?.wallet_address;
  const generatedWallets = wallets || user.user_metadata?.wallets;
  
  // Display email or wallet
  let displayText = user.email || connectedWallet || user.id;
  
  // If it's a connected wallet address, show shortened version
  if (connectedWallet && !user.email) {
    displayText = `${connectedWallet.substring(0, 6)}...${connectedWallet.substring(connectedWallet.length - 4)}`;
  }
  
  avatar.textContent = displayText[0].toUpperCase();
  
  document.getElementById('userEmail').textContent = displayText;
  document.getElementById('loginMethod').textContent = method;
  
  // Show connected wallet (MetaMask)
  if (connectedWallet) {
    document.getElementById('connectedWalletInfo').style.display = 'block';
    document.getElementById('walletAddress').textContent = connectedWallet;
    document.getElementById('generatedWalletsSection').style.display = 'none';
    document.getElementById('walletActionsSection').style.display = 'none';
  } else if (generatedWallets) {
    // Show generated wallets (EVM & Solana)
    currentWallets = generatedWallets;
    
    document.getElementById('generatedWalletsSection').style.display = 'block';
    document.getElementById('connectedWalletInfo').style.display = 'none';
    
    // Display full addresses
    document.getElementById('evmWalletAddress').textContent = generatedWallets.evm_address;
    document.getElementById('solanaWalletAddress').textContent = generatedWallets.solana_address;
    
    // Show wallet action buttons
    document.getElementById('walletActionsSection').style.display = 'block';
  } else {
    document.getElementById('generatedWalletsSection').style.display = 'none';
    document.getElementById('connectedWalletInfo').style.display = 'none';
    document.getElementById('walletActionsSection').style.display = 'none';
  }
}

// Check if user is already logged in
supabaseClient.auth.getSession().then(async ({ data: { session } }) => {
  console.log('Session check:', session);
  if (session) {
    const method = session.user.user_metadata?.login_method || session.user.app_metadata.provider || 'Email OTP';
    const walletAddress = session.user.user_metadata?.wallet_address;
    
    if (method === 'wallet' || walletAddress) {
      showUserProfile(session.user, 'Wallet', null);
    } else {
      // Generate wallets if user doesn't have them yet
      const wallets = await getOrCreateWallets(session.user);
      showUserProfile(session.user, method.charAt(0).toUpperCase() + method.slice(1), wallets);
    }
  }
});

// Listen for auth state changes
supabaseClient.auth.onAuthStateChange(async (event, session) => {
  console.log('Auth state changed:', event, session);
  if (event === 'SIGNED_IN' && session) {
    const method = session.user.user_metadata?.login_method || session.user.app_metadata.provider || 'Email OTP';
    const walletAddress = session.user.user_metadata?.wallet_address;
    
    if (method === 'wallet' || walletAddress) {
      showUserProfile(session.user, 'Wallet', null);
    } else {
      // Generate wallets for new user
      const wallets = await getOrCreateWallets(session.user);
      showUserProfile(session.user, method.charAt(0).toUpperCase() + method.slice(1), wallets);
    }
  } else if (event === 'SIGNED_OUT') {
    loginCard.style.display = 'block';
    avatar.style.display = 'none';
    currentWallets = null;
  }
});

// Handle OAuth redirect callback
window.addEventListener('load', async () => {
  const hashParams = new URLSearchParams(window.location.hash.substring(1));
  const accessToken = hashParams.get('access_token');
  
  if (accessToken) {
    console.log('OAuth callback detected, processing...');
    try {
      const { data: { session }, error } = await supabaseClient.auth.getSession();
      if (session) {
        const method = session.user.app_metadata.provider || 'OAuth';
        
        // Generate wallets for OAuth user
        const wallets = await getOrCreateWallets(session.user);
        
        showUserProfile(session.user, method.charAt(0).toUpperCase() + method.slice(1), wallets);
        // Clean URL
        window.history.replaceState({}, document.title, window.location.pathname);
      }
    } catch (error) {
      console.error('Error processing OAuth callback:', error);
    }
  }
});

// Copy Mnemonic to Clipboard
document.getElementById('copyMnemonicBtn').onclick = () => {
  if (!currentWallets || !currentWallets.mnemonic) {
    showError('No mnemonic available');
    return;
  }
  
  const mnemonic = currentWallets.mnemonic;
  navigator.clipboard.writeText(mnemonic).then(() => {
    showSuccess('Mnemonic copied to clipboard! Keep it safe!');
  }).catch(err => {
    showError('Failed to copy mnemonic');
    console.error('Copy error:', err);
  });
};

// Export Wallet Info
document.getElementById('exportWalletBtn').onclick = () => {
  if (!currentWallets) {
    showError('No wallets to export');
    return;
  }
  
  const exportData = {
    mnemonic: currentWallets.mnemonic,
    evm: {
      address: currentWallets.evm_address,
      privateKey: currentWallets.evm_private_key,
      derivationPath: currentWallets.evm_path
    },
    solana: {
      address: currentWallets.solana_address,
      secretKey: currentWallets.solana_secret_key,
      derivationPath: currentWallets.solana_path
    },
    warning: '⚠️ KEEP THIS SAFE! Never share your mnemonic or private keys with anyone!',
    info: 'You can restore both wallets using the mnemonic phrase in any compatible wallet (MetaMask, Phantom, Trust Wallet, etc).'
  };
  
  // Create downloadable JSON file
  const dataStr = JSON.stringify(exportData, null, 2);
  const dataBlob = new Blob([dataStr], { type: 'application/json' });
  const url = URL.createObjectURL(dataBlob);
  const link = document.createElement('a');
  link.href = url;
  link.download = 'uglycat-wallet-backup.json';
  link.click();
  URL.revokeObjectURL(url);
  
  showSuccess('Wallet backup exported successfully!');
};

// Avatar click - show profile
avatar.onclick = () => profilePopup.style.display = 'flex';
document.getElementById('closeProfile').onclick = () => profilePopup.style.display = 'none';

// Logout
document.getElementById('logoutBtn').onclick = async () => {
  await supabaseClient.auth.signOut();
  profilePopup.style.display = 'none';
  loginCard.style.display = 'block';
  avatar.style.display = 'none';
  emailInput.value = '';
  otpInput.value = '';
  emailSection.style.display = 'block';
  otpSection.style.display = 'none';
  currentWallets = null;
  hideMessages();
};
</script>

</body>
</html>
